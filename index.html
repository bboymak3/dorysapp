<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DORYSAPP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; background: #121212; color: white; font-family: sans-serif; }
        #map { width: 100%; height: 100vh; position: absolute; z-index: 1; }
        #auth { position: fixed; inset: 0; background: #121212; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 8000; display: none; align-items: flex-end; justify-content: center; }
        .card { background: #1e1e1e; width: 100%; max-width: 500px; padding: 20px; border-radius: 20px 20px 0 0; }
        #chat-box { height: 200px; overflow-y: auto; background: #000; padding: 10px; margin: 10px 0; border-radius: 10px; }
        .msg { margin: 5px; padding: 8px; border-radius: 8px; max-width: 80%; }
        .me { background: #2ecc71; margin-left: auto; color: black; }
        .them { background: #333; }
        input { width: 80%; padding: 10px; border-radius: 5px; border: none; }
        #side-list { position: fixed; top: 10px; right: 10px; z-index: 5000; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; max-width: 150px; }
    </style>
</head>
<body>

<div id="auth">
    <div style="text-align:center;">
        <h2>DORYSAPP</h2>
        <input type="tel" id="phone" placeholder="Tu teléfono">
        <button onclick="login()" style="padding:10px 20px; background:#2ecc71; border:none; border-radius:5px; margin-top:10px;">ENTRAR</button>
    </div>
</div>

<div id="side-list">
    <b>Activos:</b> <div id="users-active"></div>
</div>

<div id="map"></div>

<div id="user-modal" class="modal">
    <div class="card">
        <h3 id="m-name"></h3>
        <div id="chat-box"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="m-text" placeholder="Escribe...">
            <button onclick="sendMsg()" style="background:#2ecc71; border:none; padding:10px; border-radius:5px;">OK</button>
        </div>
        <button onclick="closeModal()" style="width:100%; background:none; color:white; border:none; margin-top:10px;">Cerrar</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let me = null;
    let map = null;
    let markers = {};
    let myMarker = null;
    let activePartner = null;
    let chatInt = null;

    async function login() {
        const phone = document.getElementById('phone').value;
        const res = await fetch(`/api/check-user?phone=${phone}`);
        const data = await res.json();
        
        if (data.found) me = data.user;
        else {
            me = { id: 'U'+Date.now(), name: 'Usuario', phone: phone, role: 'Usuario', lat: 0, lng: 0 };
            await fetch('/api/user', { method: 'POST', body: JSON.stringify(me) });
        }
        
        document.getElementById('auth').style.display = 'none';
        initMap();
    }

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([0,0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude } = pos.coords;
            me.lat = latitude; me.lng = longitude;

            if (!myMarker) {
                myMarker = L.circleMarker([latitude, longitude], { color: '#3498db', radius: 12 }).addTo(map).bindPopup("Tú");
                map.setView([latitude, longitude], 15);
            } else {
                myMarker.setLatLng([latitude, longitude]);
            }
            fetch('/api/user', { method: 'POST', body: JSON.stringify(me) });
        }, null, { enableHighAccuracy: true });

        setInterval(sync, 5000);
    }

    async function sync() {
        const res = await fetch('/api/users');
        const users = await res.json();
        const list = document.getElementById('users-active');
        list.innerHTML = '';

        users.forEach(u => {
            if (u.id === me.id) return;
            
            list.innerHTML += `<div onclick="openUser('${u.id}')" style="cursor:pointer; margin:5px 0;">• ${u.name}</div>`;

            if (!markers[u.id]) {
                markers[u.id] = L.marker([u.lat, u.lng]).addTo(map).on('click', () => openUser(u));
            } else {
                markers[u.id].setLatLng([u.lat, u.lng]);
            }
        });
    }

    async function openUser(u) {
        if (typeof u === 'string') { // Si viene de la lista
            const res = await fetch('/api/users');
            const all = await res.json();
            activePartner = all.find(x => x.id === u);
        } else activePartner = u;

        document.getElementById('m-name').innerText = activePartner.name;
        document.getElementById('user-modal').style.display = 'flex';
        
        loadChat();
        if (chatInt) clearInterval(chatInt);
        chatInt = setInterval(loadChat, 3000);
    }

    async function loadChat() {
        if (!activePartner) return;
        const res = await fetch(`/api/get-messages?u1=${me.id}&u2=${activePartner.id}`);
        const msgs = await res.json();
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => `<div class="msg ${m.from_id === me.id ? 'me' : 'them'}">${m.text}</div>`).join('');
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const text = document.getElementById('m-text').value;
        if (!text) return;
        await fetch('/api/send-message', {
            method: 'POST',
            body: JSON.stringify({ from_id: me.id, to_id: activePartner.id, text })
        });
        document.getElementById('m-text').value = '';
        loadChat();
    }

    function closeModal() {
        document.getElementById('user-modal').style.display = 'none';
        activePartner = null;
        clearInterval(chatInt);
    }
</script>
</body>
</html>