<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DORYSAPP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #121212; --surface: #1e1e1e; --primary: #2ecc71; --text: #fff; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        #map { width: 100%; height: 100vh; background: #000; }
        
        /* AUTH */
        #auth-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--surface); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group input { width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: var(--primary); }

        /* LISTA LATERAL */
        #online-list { position: fixed; top: 80px; right: 10px; z-index: 1000; width: 150px; background: rgba(30,30,30,0.8); border-radius: 10px; padding: 10px; max-height: 200px; overflow-y: auto; font-size: 0.8rem; }
        
        .hidden { display: none !important; }
        .custom-pin { border-radius: 50%; border: 2px solid white; display: flex; justify-content: center; align-items: center; color: white; background: var(--primary); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2>DORYSAPP</h2>
            <div id="login-view">
                <div class="input-group"><input type="tel" id="login-phone" placeholder="Teléfono..."></div>
                <button class="btn" onclick="checkUser()">Entrar</button>
            </div>
            <div id="register-view" class="hidden">
                <div class="input-group"><input type="text" id="reg-name" placeholder="Tu Nombre..."></div>
                <button class="btn" onclick="registerUser()">Completar Registro</button>
            </div>
        </div>
    </div>

    <div id="online-list" class="hidden">
        <p style="color:var(--primary); font-weight:bold; margin-bottom:5px;">ACTIVOS</p>
        <div id="user-list-content"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const appState = { 
            user: null, map: null, markers: {}, 
            myMarker: null 
        };

        async function checkUser() {
            const phone = document.getElementById('login-phone').value;
            const res = await fetch(`/api/check-user?phone=${phone}`);
            const data = await res.json();
            if(data.found) enterApp(data.user);
            else document.getElementById('login-view').classList.add('hidden'), document.getElementById('register-view').classList.remove('hidden');
        }

        async function registerUser() {
            const user = {
                id: 'U' + Date.now(),
                name: document.getElementById('reg-name').value,
                phone: document.getElementById('login-phone').value,
                role: 'user', lat: 0, lng: 0
            };
            await fetch('/api/user', { method: 'POST', body: JSON.stringify(user) });
            enterApp(user);
        }

        function enterApp(user) {
            appState.user = user;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('online-list').classList.remove('hidden');

            appState.map = L.map('map', { zoomControl: false }).setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(appState.map);

            // Rastreo de ubicación
            navigator.geolocation.watchPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                appState.user.lat = latitude;
                appState.user.lng = longitude;

                // Actualizar mi propio marcador
                if(!appState.myMarker) {
                    appState.myMarker = L.marker([latitude, longitude]).addTo(appState.map).bindPopup("Tú");
                    appState.map.setView([latitude, longitude], 15);
                } else {
                    appState.myMarker.setLatLng([latitude, longitude]);
                }

                // Enviar a DB
                fetch('/api/user', { method: 'POST', body: JSON.stringify(appState.user) });
            }, (err) => console.error("Error GPS:", err), { enableHighAccuracy: true });

            setInterval(syncWorld, 5000);
            syncWorld();
        }

        async function syncWorld() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                
                const listContent = document.getElementById('user-list-content');
                listContent.innerHTML = '';
                
                const activeIds = users.map(u => u.id);

                // Borrar inactivos
                Object.keys(appState.markers).forEach(id => {
                    if(!activeIds.includes(id)) {
                        appState.map.removeLayer(appState.markers[id]);
                        delete appState.markers[id];
                    }
                });

                // Dibujar otros
                users.forEach(u => {
                    if(u.id === appState.user.id) return;

                    // Lista
                    listContent.innerHTML += `<div>${u.name}</div>`;

                    // Mapa
                    if(!appState.markers[u.id]) {
                        appState.markers[u.id] = L.marker([u.lat, u.lng]).addTo(appState.map).bindPopup(u.name);
                    } else {
                        appState.markers[u.id].setLatLng([u.lat, u.lng]);
                    }
                });
            } catch(e) { console.error("Error sync:", e); }
        }
    </script>
</body>
</html>